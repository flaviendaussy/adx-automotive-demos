<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fleet Trips</title>

    <meta charset="utf-8" />
    <link rel="shortcut icon" href="/favicon.ico" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This sample shows how to create a custome 3D layer with deck.gl." />
    <meta name="author" content="Microsoft Azure Maps" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" rel="stylesheet" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- deck.gl is a WebGL-powered framework for visual exploratory data analysis of large datasets. -->
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

    <script>
        var map;

        // A custom implementation of WebGLLayer
        class DeckGLLayer extends atlas.layer.WebGLLayer {
            constructor(options) {
                super(options.id);

                // Create an instance of deck.gl layer
                this._mbLayer = new deck.MapboxLayer(options);

                // Create a renderer
                const renderer = {
                    renderingMode: "3d",
                    onAdd: (map, gl) => {
                        this._mbLayer.onAdd?.(map["map"], gl);
                    },
                    onRemove: (map, gl) => {
                        this._mbLayer.onRemove?.(map["map"], gl);
                    },
                    prerender: (gl, matrix) => {
                        this._mbLayer.prerender?.(gl, matrix);
                    },
                    render: (gl, matrix) => {
                        this._mbLayer.render(gl, matrix);
                    }
                };
                this.setOptions({ renderer });
            }
        }

        function GetMap() {
            map = new atlas.Map("map", {
                //center: [-73.995893, 40.710164],
                center: [-122.12, 47.64],
                zoom: 14,
                pitch: 45,
                style: "grayscale_dark",
                antialias: true,
                renderWorldCopies: false,
                showBuildingModels: true,
                showFeedbackLink: false,

                // Add authentication details for connecting to Azure Maps.
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'iIuIl0MYFClTWtOXpfGpiKsZRgYo5ge4mClUsnxQqW4'
                }
            });

            // Wait until the map resources are ready
            map.events.add("ready", function () {
                layers.forEach((layer) => {
                    map.layers.add(layer);
                });

                animate();

                // Add controls
                map.controls.add(
                    [
                        new atlas.control.ZoomControl(),
                        new atlas.control.PitchControl(),
                        new atlas.control.CompassControl(),
                        new atlas.control.StyleControl({
                            mapStyles: ["road", "grayscale_light", "grayscale_dark", "satellite", "satellite_road_labels"]
                        })
                    ],
                    {
                        position: "top-right"
                    }
                );
            });
        }

        const DATA_URL = {
            TRIPS: "/geospatial/trips"
        };

        const DEFAULT_THEME = {
            trailColor0: [250, 250, 93],
            trailColor1: [50, 230, 50]
        };

        const loopLength = 1800; // unit corresponds to the timestamp in source data
        let animationSpeed = 5;
        let trailLength = 180;
        let time = 500;

        const layers = [
            new DeckGLLayer({
                id: "trips",
                type: deck.TripsLayer,
                data: DATA_URL.TRIPS,
                getPath: (d) => d.path,
                getTimestamps: (d) => d.timestamps,
                getColor: (d) => (d.vendor === 0 ? DEFAULT_THEME.trailColor0 : DEFAULT_THEME.trailColor1),
                opacity: 0.3,
                widthMinPixels: 4,
                rounded: true,
                trailLength,
                currentTime: time,
                shadowEnabled: false
            })
        ];

        const animate = () => {
            time = (time + animationSpeed) % loopLength;
            map.layers.remove("trips");
            map.layers.add(
                new DeckGLLayer({
                    id: "trips",
                    type: deck.TripsLayer,
                    data: DATA_URL.TRIPS,
                    getPath: (d) => d.path,
                    getTimestamps: (d) => d.timestamps,
                    getColor: (d) => (d.vendor === 0 ? DEFAULT_THEME.trailColor0 : DEFAULT_THEME.trailColor1),
                    opacity: 0.3,
                    widthMinPixels: 2,
                    rounded: true,
                    trailLength,
                    currentTime: time,
                    shadowEnabled: false
                })
            );
            window.requestAnimationFrame(animate);
        };
    </script>
</head>
<body onload="GetMap()">
    <div id="map" onClick="toggleRotate()" style="position:relative;width:100%;min-width:290px;height:100%;min-height:600px;background-color:gray"></div>    
</body>
</html>